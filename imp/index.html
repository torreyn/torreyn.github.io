<!DOCTYPE html>
<html>
<title>Blink!</title>
<head>
<link rel="stylesheet" href="css/normalize.css" type="text/css" media="screen" title="no title" charset="utf-8">
<link rel="stylesheet" href="css/default.css" type="text/css" media="screen" title="no title" charset="utf-8">
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="http://cdn.pubnub.com/pubnub.min.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.1/jquery-ui.min.js"></script>
<link href='http://fonts.googleapis.com/css?family=Raleway:400,700' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Raleway+Dots' rel='stylesheet' type='text/css'>
<style type="text/css">

</style>
<script>

</script>

</head>
<body>
	<a href="#" class="button" style="display: none" id="blinkonBtn"><h1>On</h1></a>
	<a href="#" class="button" style="display: none" id="blinkoffBtn"><h1>Off</h1></a>
<script>

	/* FUTURE improvements
		sanitize data
	*/

	// function to display on or off button. 
	// m=1, button is off (LED is on)
	// m=0, button is on (LED is off)
	function changeUI(m) {
		if (m == 0) {
    		$('#blinkoffBtn').hide();
			$('#blinkonBtn').show();
    	} else {
			$('#blinkoffBtn').show();
			$('#blinkonBtn').hide();
    	}
	}

	// sets up pubnub object with my publish and subscripe keys
	var pubnub = PUBNUB.init({
		publish_key: 'pub-c-8e754b2b-24aa-4789-ad62-7b61a617638a',
		subscribe_key: 'sub-c-c9109118-35f7-11e4-b33d-02ee2ddab7fe'
	});

	// function to write to pubNub the state (s)
	// pubNub then sends it off to all subscribers (web pages, and imp Agent)
 	function setLed(s) {
    	pubnub.publish({
        	channel : "cSoXBdTAs8xZ-ledState",
		    message : "{ \"state\": " + s + " }"
		});
    }

 	// subscribe to LED channel
	pubnub.subscribe({
    	channel : "cSoXBdTAs8xZ-ledState",
        message : function(m) {
        	console.log(m);	
			var data = $.parseJSON(m);
			changeUI(data.state);
        }
    });
	
	// jQuery lister functions for on and off
	$('#blinkonBtn').click(function() {
		setLed(1);
	});
	$('#blinkoffBtn').click(function() {
		setLed(0);
	});

	// sends get request to my imp Agent. Takes the value returned to set
	// initial state of UI (on/off depending on what it reads from the agent)
	$.ajax({
		method: "GET",
		url: "https://agent.electricimp.com/cSoXBdTAs8xZ",
		success: function(m) {
			changeUI(m);
		}
	});

</script>


</body>
</html>